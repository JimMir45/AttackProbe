# AttackProbe 系统架构设计

> 版本: v0.1 (草稿) | 创建日期: 2025-01-15 | 状态: 待设计

## 1. 架构概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                           用户层                                     │
│                     Web Browser / API Client                        │
└───────────────────────────────┬─────────────────────────────────────┘
                                │ HTTPS
┌───────────────────────────────▼─────────────────────────────────────┐
│                         展示层 (Frontend)                            │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │ 仪表盘  │ │资产管理 │ │任务中心 │ │报告中心 │ │系统设置 │       │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │
│                        Vue 3 + Element Plus                         │
└───────────────────────────────┬─────────────────────────────────────┘
                                │ REST API
┌───────────────────────────────▼─────────────────────────────────────┐
│                          接入层 (Gateway)                            │
│         Gin Router + Middleware (CORS/Auth/Logger/Recovery)         │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────────┐
│                         业务层 (Service)                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │
│  │TargetService│ │TestCaseSvc  │ │ TaskService │ │ReportService│   │
│  │ 目标管理    │ │ 用例管理    │ │ 任务调度    │ │ 报告生成    │   │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────────┐
│                        引擎层 (Engine)                               │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Task Executor                             │   │
│  │              (Worker Pool + Context Cancel)                  │   │
│  └─────────────────────────────┬───────────────────────────────┘   │
│                                │                                    │
│  ┌─────────────────────────────▼───────────────────────────────┐   │
│  │                   Attack Engine                              │   │
│  │  ┌─────────────────┐      ┌─────────────────────────────┐   │   │
│  │  │ Traditional BAS │      │       LLM Security BAS      │   │   │
│  │  │ • 漏洞扫描模拟   │      │ • Prompt Injection (20)    │   │   │
│  │  │ • 网络攻击模拟   │      │ • Jailbreak (18)           │   │   │
│  │  │ • Payload执行   │      │ • Info Disclosure (15)     │   │   │
│  │  └─────────────────┘      └─────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                │                                    │
│  ┌─────────────────────────────▼───────────────────────────────┐   │
│  │                    Judge Engine                              │   │
│  │           (Keyword Match / Rule-based / AI Judge)            │   │
│  └─────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────────┐
│                         数据层 (Repository)                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │
│  │TargetRepo   │ │TestCaseRepo │ │  TaskRepo   │ │ ConfigRepo  │   │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │
│                           GORM ORM                                  │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────────┐
│                         存储层 (Storage)                             │
│                        SQLite Database                              │
│                     ./data/AttackProbe.db                              │
└─────────────────────────────────────────────────────────────────────┘

                    外部依赖
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ Target Host │ │  LLM API    │ │   其他      │
│ (被测目标)  │ │(OpenAI兼容) │ │   ...       │
└─────────────┘ └─────────────┘ └─────────────┘
```

---

## 2. 模块设计

### 2.1 目录结构

```
AttackProbe/
├── cmd/
│   └── server/
│       └── main.go              # 程序入口
├── internal/
│   ├── config/                  # 配置管理
│   ├── controller/              # HTTP控制器
│   │   ├── target.go
│   │   ├── testcase.go
│   │   ├── task.go
│   │   └── report.go
│   ├── service/                 # 业务逻辑
│   │   ├── target.go
│   │   ├── testcase.go
│   │   ├── task.go
│   │   ├── executor.go          # 任务执行器
│   │   └── report.go
│   ├── repository/              # 数据访问
│   ├── model/                   # 数据模型
│   │   ├── target.go
│   │   ├── testcase.go
│   │   ├── task.go
│   │   └── builtin_cases.go     # 内置用例
│   ├── engine/                  # 攻击引擎
│   │   ├── traditional/         # 传统BAS引擎
│   │   └── llm/                 # LLM安全引擎(复用)
│   ├── judge/                   # 判定引擎
│   ├── router/                  # 路由配置
│   └── middleware/              # 中间件
├── pkg/                         # 公共包
│   ├── llm/                     # LLM客户端
│   └── utils/
├── web/                         # 前端源码
│   ├── src/
│   │   ├── views/
│   │   ├── components/
│   │   ├── api/
│   │   └── router/
│   └── package.json
├── static/                      # 编译后前端资源
├── data/                        # 数据目录
├── Makefile
└── go.mod
```

### 2.2 数据模型

```sql
-- 目标表
CREATE TABLE target (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT NOT NULL,          -- 'http' | 'llm' | 'network'
    endpoint TEXT NOT NULL,
    config TEXT,                 -- JSON配置
    status TEXT DEFAULT 'active',
    last_test_time DATETIME,
    created_at DATETIME,
    updated_at DATETIME
);

-- 测试用例表
CREATE TABLE testcase (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    category TEXT NOT NULL,      -- 'prompt_injection' | 'jailbreak' | ...
    target_type TEXT NOT NULL,   -- 'llm' | 'http' | 'network'
    risk_level TEXT NOT NULL,    -- 'high' | 'medium' | 'low'
    content TEXT NOT NULL,       -- 攻击内容
    judge_method TEXT,           -- 判定方法
    judge_config TEXT,           -- 判定配置(JSON)
    enabled INTEGER DEFAULT 1,
    builtin INTEGER DEFAULT 0,   -- 是否内置
    created_at DATETIME,
    updated_at DATETIME
);

-- 任务表
CREATE TABLE task (
    id INTEGER PRIMARY KEY,
    name TEXT,
    target_id INTEGER NOT NULL,
    status TEXT DEFAULT 'pending', -- pending|running|completed|cancelled
    total_count INTEGER DEFAULT 0,
    completed_count INTEGER DEFAULT 0,
    success_count INTEGER DEFAULT 0,
    failed_count INTEGER DEFAULT 0,
    error_count INTEGER DEFAULT 0,
    started_at DATETIME,
    finished_at DATETIME,
    created_at DATETIME,
    FOREIGN KEY (target_id) REFERENCES target(id)
);

-- 任务结果表
CREATE TABLE task_result (
    id INTEGER PRIMARY KEY,
    task_id INTEGER NOT NULL,
    testcase_id INTEGER NOT NULL,
    status TEXT DEFAULT 'pending',
    request TEXT,
    response TEXT,
    judge_result INTEGER,        -- 1=防护成功 0=防护失败
    judge_reason TEXT,
    duration_ms INTEGER,
    error_message TEXT,
    executed_at DATETIME,
    FOREIGN KEY (task_id) REFERENCES task(id),
    FOREIGN KEY (testcase_id) REFERENCES testcase(id)
);
```

---

## 3. API设计

### 3.1 API清单

| 模块 | Method | Path | 描述 |
|------|--------|------|------|
| **目标** | POST | /api/v1/target/add | 添加目标 |
| | POST | /api/v1/target/update | 更新目标 |
| | POST | /api/v1/target/delete | 删除目标 |
| | POST | /api/v1/target/page | 分页查询 |
| | POST | /api/v1/target/test | 连通性测试 |
| **用例** | POST | /api/v1/testcase/page | 分页查询 |
| | POST | /api/v1/testcase/stats | 统计信息 |
| | POST | /api/v1/testcase/toggle | 启用/禁用 |
| **任务** | POST | /api/v1/task/add | 创建任务 |
| | POST | /api/v1/task/start | 启动任务 |
| | POST | /api/v1/task/cancel | 取消任务 |
| | POST | /api/v1/task/page | 分页查询 |
| | POST | /api/v1/task/detail | 任务详情 |
| | POST | /api/v1/task/progress | 执行进度 |
| | POST | /api/v1/task/results | 执行结果 |
| **报告** | POST | /api/v1/report/summary | 统计摘要 |
| | POST | /api/v1/report/export | 导出报告 |
| **系统** | GET | /api/health | 健康检查 |
| | POST | /api/v1/system/config | 配置管理 |

---

## 4. 执行流程

### 4.1 任务执行流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 创建任务 │───▶│ 启动任务 │───▶│ 分发用例 │───▶│ 并发执行 │
└─────────┘    └─────────┘    └─────────┘    └────┬────┘
                                                  │
                    ┌─────────────────────────────┘
                    ▼
              ┌─────────┐    ┌─────────┐    ┌─────────┐
              │ 发送请求 │───▶│ 接收响应 │───▶│ 结果判定 │
              └─────────┘    └─────────┘    └────┬────┘
                                                  │
                    ┌─────────────────────────────┘
                    ▼
              ┌─────────┐    ┌─────────┐
              │ 存储结果 │───▶│ 更新进度 │
              └─────────┘    └─────────┘
```

---

## 5. 待补充内容

第2月团队到岗后补充:

- [ ] 详细接口定义
- [ ] 错误码设计
- [ ] 安全设计
- [ ] 部署架构
- [ ] 监控方案

---

## 变更记录

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2025-01-15 | v0.1 | 初稿创建 | SecOps Team |
